// XHook - v1.1.0 - https://github.com/jpillora/xhook
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2013
!function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;m=a.document,c="before",b="after",i="readyState",h="addEventListener",g="removeEventListener",f="dispatchEvent",k="XMLHttpRequest",j=["load","loadend","loadstart"],d=["progress","abort","error","timeout"],(r=Array.prototype).indexOf||(r.indexOf=function(a){var b,c,d,e;for(b=d=0,e=this.length;e>d;b=++d)if(c=this[b],c===a)return b;return-1}),o=function(a,b){var c,d;for(c in a)d=a[c],b[c]=d},p=function(a,b,c){var d,e,g,h;for(e=function(a){return function(d){var e,g,h;e={};for(g in d)h=d[g],e[g]=h===b?c:h;return c[f](a,e)}},g=0,h=a.length;h>g;g++)d=a[g],b["on"+d]=e(d)},n=function(a){var b;if(null!=m.createEventObject)return b=m.createEventObject(),b.type=a,b;try{return new Event(a)}catch(c){return{type:a}}},e=function(a){var b,c,d;return c={},d=function(a){return c[a]||[]},b={},b[h]=function(a,b,e){c[a]=d(a),c[a].indexOf(b)>=0||(e=void 0===e?c[a].length:e,c[a].splice(e,0,b))},b[g]=function(a,b){var c;c=d(a).indexOf(b),-1!==c&&d(a).splice(c,1)},b[f]=function(a,c){var e,f,g,h,i,j,k;for(e=n(a),o(c,e),g=b["on"+a],g&&g(e),k=d(a),f=i=0,j=k.length;j>i;f=++i)h=k[f],h(e)},a&&(b.listeners=function(a){return Array.prototype.slice.call(d(a))},b.on=b[h],b.off=b[g],b.fire=b[f]),b},q=e(!0),q[c]=function(a,b){if(a.length<1||a.length>2)throw"!";return q[h](c,a,b)},q[b]=function(a,c){if(a.length<2||a.length>3)throw"!";return q[h](b,a,c)},l=function(a,b){var c,d,e,f,g,h;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)f=a[e],d.push(""+e+":	"+f);return d.join("\n");case"string":for(d=a.split("\n"),g=0,h=d.length;h>g;g++)c=d[g],/([^:]+):\s*(.+)/.test(c)&&(b[RegExp.$1]||(b[RegExp.$1]=RegExp.$2));return b}},q.headers=l,q[k]=a[k],a[k]=function(){var a,g,m,r,s,t,u,v,w,x,y,z,A,B,C;C=new q[k],y=!1,v=e(!0),v.headers={},w={},w.headers={},B=function(){m.status=w.status,m.statusText=w.statusText},A=function(){m.responseType=w.type||"",m.response=w.data||null,m.responseText=w.text||w.data||"",m.responseXML=w.xml||null},u=function(){var a,b,c;w.status=C.status,w.statusText=C.statusText,c=l(C.getAllResponseHeaders());for(a in c)b=c[a],w.headers[a]||(w.headers[a]=b)},t=function(){w.type=C.responseType,w.text=C.responseText,w.data=C.response||w.text,w.xml=C.responseXML},g=0,x=function(a){var c,d,e;return c=function(){for(;a>g&&4>g;)m[i]=++g,1===g&&m[f]("loadstart",n("loadstart")),2===g&&B(),4===g&&(B(),A()),m[f]("readystatechange",n("readystatechange")),4===g&&(m[f]("load",n("load")),m[f]("loadend",n("loadend")))},4>a?(c(),void 0):(d=q.listeners(b),e=function(){var a;return d.length?(a=d.shift(),2===a.length?(a(v,w),e()):3===a.length?a(v,w,e):void 0):c()},e(),void 0)},C.onreadystatechange=function(){try{2===C[i]&&u()}catch(a){}4===C[i]&&(y=!1,u(),t()),x(C[i])},m=e(),m[h]("progress",function(){return x(3)}),p(d,C,m),v.on=function(a,b){m[h](a,b)},v.fire=function(a,b){m[f](a,b)},m.withCredentials=!1,m.response=null,m.status=0,m.open=function(a,b,c,d,e){if(v.method=a,v.url=b,c===!1)throw"sync xhr not supported by XHook";v.user=d,v.pass=e,x(1)},m.send=function(a){var b,d,e;v.body=a,e=function(){var a,b,c;y=!0,C.open(v.method,v.url,!0,v.user,v.pass),C.timeout=v.timeout||m.timeout,c=v.headers;for(a in c)b=c[a],C.setRequestHeader(a,b);C.send(v.body)},b=q.listeners(c),d=function(){var a,c;return b.length?(a=function(a){return"object"!=typeof a||"number"!=typeof a.status&&"number"!=typeof w.status?(d(),void 0):(o(a,w),x(4),void 0)},a.head=function(a){return o(a,w),x(2)},a.text=function(a){return w.text=a,x(3)},c=b.shift(),1===c.length?a(c(v)):2===c.length?c(v,a):void 0):e()},d()},m.abort=function(){y&&C.abort(),m[f]("abort",arguments)},m.setRequestHeader=function(a,b){v.headers[a]=b},m.getResponseHeader=function(a){return w.headers[a]},m.getAllResponseHeaders=function(){return l(w.headers)},C.overrideMimeType&&(m.overrideMimeType=function(){return C.overrideMimeType.apply(C,arguments)}),C.upload&&(m.upload=v.upload=e(),p(d.concat(j),C.upload,m.upload)),a=v.calls=e(!0),z=function(b,c){return function(){return a.fire(b,arguments),c.apply(void 0,arguments)}};for(s in m)r=m[s],"function"==typeof r&&(m[s]=z(s,r));return m},a.xhook=q}(this);