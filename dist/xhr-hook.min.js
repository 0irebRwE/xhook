// XHR Hook - v0.1.0 - https://github.com/jpillora/xhr-hook
// Â© Jaime Pillora <dev@jpillora.com> 2013
!function(a,b,c){var d,e,f,g,h,i,j,k=[].slice,l=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};e=["open","setRequestHeader","send","abort","getAllResponseHeaders","getResponseHeader","overrideMimeType","addEventListener","removeEventListener","dispatchEvent"],d=["onreadystatechange","onprogress","onloadstart","onloadend","onload","onerror","onabort"],f=["statusText","status","response","responseType","responseXML","responseText","upload","readyState","withCredentials"],h=function(a){var b;return b=function(){},b.prototype=a,new b},g=function(a){return g.s.push(a)},g.s=[],i=function(b){var c;return(c=a[b])?a[b]=function(a){return"string"!=typeof a||/\.XMLHTTP/.test(a)?(console.log("creating a "+b),j(new c(a),c)):void 0}:void 0},i("ActiveXObject"),i("XMLHttpRequest"),j=function(a){var b,i,j,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;for(t={},s={withCredentials:!1},j={requestHeaders:{},responseHeaders:{}},r=h(j),r.callbacks=[],r.on=function(a,b){return(r.callbacks[a]||(r.callbacks[a]=[])).push(b)},u=function(b){return s[b]=function(){var c,d,e,f,g,h,i,l;switch(c=1<=arguments.length?k.call(arguments,0):[],b){case"send":j.data=c[0];break;case"open":j.method=c[0],j.url=c[1],j.async=c[2];break;case"setRequestHeader":j.requestHeaders[c[0]]=c[1]}if(f=c,e=r.callbacks["call:"+b])for(i=0,l=e.length;l>i;i++)d=e[i],g=d(c),g&&(f=g);return a[b]&&(h=a[b].apply(a,f)),h}},w=0,z=e.length;z>w;w++)n=e[w],u(n);for(p=function(){var b,c,d,e;try{for(e=[],c=0,d=f.length;d>c;c++)b=f[c],e.push(q(b,a[b]));return e}catch(g){}},q=function(b,d){var e,f,g,h,i,k,l,m,n,o,p,q;if(l=t[b],d!==l){if(t[b]=d,"readyState"===b&&2===d)for(j.statusCode=a.status,i=a.getAllResponseHeaders().split("\n"),n=0,p=i.length;p>n;n++)h=i[n],g=/([^:]+):\s*(.*)/.test(h)?{k:RegExp.$1,v:RegExp.$2}:void 0,g&&(j.responseHeaders[g.k]=g.v);if(f=r.callbacks["set:"+b])for(o=0,q=f.length;q>o;o++)e=f[o],m=e(d,l),m!==c&&(k=m);return s[b]=k===c?d:k}},i=function(b){var c,d,e;c={};for(d in b)e=b[d],c[d]=e===a?s:e;return c},v=function(b){return a[b]=function(a){var c;return p(),a&&(c=i(a)),s[b]?s[b].call(s,c):void 0}},x=0,A=d.length;A>x;x++)m=d[x],v(m);p();for(o in a)if(s[o]===c&&l.call(d,o)<0)try{s[o]=a[o]}catch(D){}for(C=g.s,y=0,B=C.length;B>y;y++)b=C[y],b.call(null,r);return s},a.XHRHook=g}(window,document);